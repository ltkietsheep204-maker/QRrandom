<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‚öî Th·ª≠ th√°ch L·ªãch s·ª≠ - Boardgame Phong Ki·∫øn</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ==================== PLAY PAGE SPECIFIC STYLES ==================== */
    body {
      background: #1a0f0a;
    }

    .bg-pattern {
      background:
        radial-gradient(ellipse at top, rgba(139, 26, 26, 0.5) 0%, transparent 60%),
        radial-gradient(ellipse at bottom right, rgba(93, 64, 55, 0.4) 0%, transparent 60%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4a843' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
        linear-gradient(180deg, #2C1810 0%, #1a0f0a 50%, #0d0705 100%);
    }

    /* Loading Screen */
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      text-align: center;
    }

    .loading-logo {
      margin-bottom: 25px;
      filter: drop-shadow(0 4px 15px rgba(212,168,67,0.5));
      animation: floatLantern 3s ease-in-out infinite;
    }

    .loading-logo img {
      width: 1000px;
      max-width: 90vw;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .loading-title {
      font-family: 'Playfair Display', serif;
      font-size: 2.4rem;
      color: var(--gold);
      text-shadow: 2px 2px 8px rgba(0,0,0,0.7), 0 0 30px rgba(212,168,67,0.3);
      margin-bottom: 8px;
      letter-spacing: 4px;
      text-transform: uppercase;
    }

    .loading-subtitle {
      font-family: 'Crimson Text', serif;
      font-size: 1.1rem;
      color: var(--gold-light);
      font-style: italic;
      margin-bottom: 40px;
      opacity: 0.8;
    }

    .loading-bar-container {
      width: 80%;
      max-width: 400px;
      height: 8px;
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(212,168,67,0.3);
      margin-bottom: 15px;
    }

    .loading-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--gold-dark), var(--gold), var(--gold-light));
      border-radius: 10px;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(212,168,67,0.5);
    }

    .loading-percent {
      color: var(--gold-light);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .loading-tip {
      color: rgba(255,248,231,0.5);
      font-size: 0.85rem;
      font-style: italic;
      margin-top: 20px;
      max-width: 350px;
    }

    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(3, end) infinite;
    }

    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }

    /* Welcome Screen */
    .welcome-screen {
      text-align: center;
      padding: 40px 20px;
      animation: fadeInUp 0.8s;
    }

    .welcome-logo {
      margin-bottom: 5px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
    }

    .welcome-logo img {
      width: 800px;
      max-width: 85vw;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .welcome-title {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      color: var(--gold);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .welcome-subtitle {
      font-family: 'Crimson Text', serif;
      font-size: 1.1rem;
      color: var(--gold-light);
      font-style: italic;
      margin-bottom: 30px;
    }

    .welcome-desc {
      color: rgba(255,248,231,0.7);
      font-size: 0.95rem;
      line-height: 1.7;
      max-width: 400px;
      margin: 0 auto 30px;
    }

    .welcome-rules {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(212, 168, 67, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .welcome-rules h3 {
      color: var(--gold);
      font-size: 1rem;
      margin-bottom: 10px;
      text-align: center;
    }

    .welcome-rules ul {
      list-style: none;
      padding: 0;
    }

    .welcome-rules ul li {
      padding: 5px 0;
      font-size: 0.9rem;
      color: var(--cream-dark);
      padding-left: 25px;
      position: relative;
    }

    .welcome-rules ul li::before {
      content: '‚öî';
      position: absolute;
      left: 0;
    }

    .start-btn {
      padding: 18px 60px;
      font-size: 1.3rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--red-royal), var(--red-dark));
      border: 3px solid var(--gold);
      color: var(--gold);
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Be Vietnam Pro', sans-serif;
      text-transform: uppercase;
      letter-spacing: 3px;
      animation: glow 2s ease-in-out infinite;
    }

    .start-btn:hover {
      background: linear-gradient(135deg, var(--red-bright), var(--red-royal));
      transform: scale(1.05);
    }

    /* Phase transitions */
    .phase {
      display: none;
      animation: fadeInUp 0.6s;
    }

    .phase.active {
      display: block;
    }

    /* Timer / progress */
    .quiz-timer {
      text-align: center;
      margin-bottom: 15px;
    }

    .timer-bar {
      width: 100%;
      height: 4px;
      background: rgba(0,0,0,0.3);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }

    .timer-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--red-bright));
      border-radius: 2px;
      transition: width 1s linear;
    }

    /* Correct answer celebration */
    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
    }

    /* Floating lanterns decoration */
    .lantern {
      position: fixed;
      font-size: 2rem;
      opacity: 0.15;
      animation: floatLantern 8s ease-in-out infinite;
      z-index: 1;
    }

    @keyframes floatLantern {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    /* Wheel specific for this page */
    .wheel-section {
      padding: 20px;
    }

    .transition-text {
      text-align: center;
      padding: 20px;
      animation: fadeInUp 0.5s;
    }

    .transition-text p {
      font-size: 1.1rem;
      color: var(--gold-light);
      margin-bottom: 15px;
    }

    /* Final prize display */
    .final-prize {
      text-align: center;
      padding: 30px 20px;
      animation: fadeInUp 0.6s;
    }

    .final-prize .trophy {
      font-size: 6rem;
      display: block;
      margin-bottom: 15px;
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .final-prize h2 {
      font-family: 'Playfair Display', serif;
      color: var(--gold);
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    .final-prize .prize-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: #FFD700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      margin: 15px 0;
    }

    .final-prize .back-msg {
      color: var(--gold-light);
      font-size: 1rem;
      margin-top: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      border: 1px solid rgba(212, 168, 67, 0.3);
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>

  <!-- Decorative lanterns -->
  <div class="lantern" style="top:10%; left:5%;">üèÆ</div>
  <div class="lantern" style="top:30%; right:8%; animation-delay: -2s;">üèÆ</div>
  <div class="lantern" style="top:60%; left:3%; animation-delay: -4s;">üèÆ</div>
  <div class="lantern" style="top:80%; right:5%; animation-delay: -6s;">üèÆ</div>

  <!-- Confetti container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <div class="quiz-wrapper">

    <!-- ==================== PHASE 0: LOADING ==================== -->
    <div id="phase-loading" class="phase active">
      <div class="loading-screen">
        <div class="loading-logo"><img src="img/logo.png" alt="Logo Nh·∫•t Th·ªëng ƒê·∫°i Vi·ªát" /></div>
        <div class="loading-title">Nh·∫•t Th·ªëng ƒê·∫°i Vi·ªát</div>
        <div class="loading-subtitle">Boardgame L·ªãch S·ª≠ Phong Ki·∫øn Vi·ªát Nam</div>
        <div class="loading-bar-container">
          <div class="loading-bar-fill" id="loadingBar"></div>
        </div>
        <div class="loading-percent" id="loadingPercent">0%</div>
        <div class="loading-tip">
          <span class="loading-dots">ƒêang t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠</span>
        </div>
      </div>
    </div>
    
    <!-- ==================== PHASE 1: WELCOME ==================== -->
    <div id="phase-welcome" class="phase">
      <div class="welcome-screen">
        <div class="welcome-logo"><img src="img/logo.png" alt="Logo" /></div>
        <div class="welcome-title">Th·ª≠ Th√°ch<br/>L·ªãch S·ª≠ Phong Ki·∫øn</div>
        <div class="welcome-subtitle">Vi·ªát Nam qua c√°c Tri·ªÅu ƒë·∫°i</div>
        
        <div class="dragon-divider">‚ùñ ‚óà ‚ùñ</div>

        <div class="welcome-desc">
          H√£y th·ª≠ s·ª©c v·ªõi ki·∫øn th·ª©c l·ªãch s·ª≠ Vi·ªát Nam th·ªùi phong ki·∫øn!
          Tr·∫£ l·ªùi ƒë√∫ng ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng cho cu·ªôc phi√™u l∆∞u c·ªßa b·∫°n.
        </div>

        <div class="welcome-rules">
          <h3>üìú Quy t·∫Øc</h3>
          <ul>
            <li>Ch·ªçn 1 ƒë√°p √°n ƒë√∫ng trong 4 ph∆∞∆°ng √°n</li>
            <li>Tr·∫£ l·ªùi ƒë√∫ng ‚Üí Quay v√≤ng quay nh·∫≠n th∆∞·ªüng</li>
            <li>Tr·∫£ l·ªùi sai ‚Üí Quay v·ªÅ tr√≤ ch∆°i b√†n c·ªù</li>
            <li>Ph·∫ßn th∆∞·ªüng d√πng trong boardgame</li>
          </ul>
        </div>

        <button class="start-btn" onclick="startQuiz()">
          ‚öî B·∫ÆT ƒê·∫¶U ‚öî
        </button>
      </div>
    </div>

    <!-- ==================== PHASE 2: QUIZ ==================== -->
    <div id="phase-quiz" class="phase">
      <div class="quiz-card">
        <div class="quiz-header">
          <div class="icon">üìú</div>
          <h2>C√¢u h·ªèi L·ªãch s·ª≠</h2>
          <span class="category-badge" id="quizCategory"></span>
        </div>

        <div class="quiz-timer">
          <span id="timerText" style="color: var(--gold-light); font-size: 0.9rem;">‚è≥ Th·ªùi gian: <span id="timerCount">30</span>s</span>
          <div class="timer-bar">
            <div class="timer-fill" id="timerFill" style="width: 100%"></div>
          </div>
        </div>

        <div class="quiz-question" id="questionText"></div>

        <div class="quiz-options" id="optionsContainer">
          <!-- Generated by JS -->
        </div>
      </div>
    </div>

    <!-- ==================== PHASE 3A: WRONG ANSWER ==================== -->
    <div id="phase-wrong" class="phase">
      <div class="quiz-card">
        <div class="result-screen show result-wrong">
          <div class="result-icon">üò¢</div>
          <div class="result-text">R·∫•t ti·∫øc üò¢, sai m·∫•t r·ªìi!</div>
          <div class="result-subtext">
            ƒê·ª´ng n·∫£n l√≤ng, h√£y ghi nh·ªõ ki·∫øn th·ª©c n√†y nh√©!
          </div>
          <div class="result-answer" id="correctAnswerDisplay"></div>
          <div class="dragon-divider">‚óà ‚óà ‚óà</div>
          <div class="result-subtext" style="margin-top: 15px;">
            üé≤ M·ªùi b·∫°n quay l·∫°i b√†n c·ªù v√† ti·∫øp t·ª•c cu·ªôc phi√™u l∆∞u!
          </div>
          <button class="btn btn-primary mt-20" onclick="resetGame()">
            üîÑ Ch∆°i l·∫°i
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== PHASE 3B: CORRECT ‚Üí TRANSITION TO WHEEL ==================== -->
    <div id="phase-correct" class="phase">
      <div class="quiz-card">
        <div class="result-screen show result-correct">
          <div class="result-icon">üéâ</div>
          <div class="result-text">‚úÖ Ch√≠nh x√°c!</div>
          <div class="result-subtext">
            Xu·∫•t s·∫Øc! Ki·∫øn th·ª©c l·ªãch s·ª≠ c·ªßa b·∫°n th·∫≠t ƒë√°ng n·ªÉ!
          </div>
          <div class="dragon-divider">‚óà ‚óà ‚óà</div>
          <div class="result-subtext" style="font-size: 1.1rem; color: var(--gold);">
            üé° M·ªùi b·∫°n quay th∆∞·ªüng!
          </div>
          <button class="btn btn-primary mt-20" onclick="showWheel()" style="font-size: 1.1rem; padding: 16px 40px;">
            üé∞ QUAY TH∆Ø·ªûNG NGAY
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== PHASE 4: SPIN WHEEL ==================== -->
    <div id="phase-wheel" class="phase">
      <div class="wheel-section">
        <div class="wheel-header">
          <h2>üé° V√≤ng Quay Ph·∫ßn Th∆∞·ªüng</h2>
          <p>Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ quay!</p>
        </div>

        <div class="wheel-container">
          <div class="wheel-pointer">‚ñº</div>
          <canvas id="wheelCanvas" class="wheel-canvas" width="340" height="340"></canvas>
          <div class="wheel-center">üèÜ</div>
        </div>

        <div style="text-align: center;">
          <button class="spin-btn" id="spinBtn" onclick="spinWheel()">
            üé∞ QUAY NGAY
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== PHASE 5: PRIZE RESULT ==================== -->
    <div id="phase-prize" class="phase">
      <div class="final-prize">
        <span class="trophy">üèÜ</span>
        <h2>Ch√∫c m·ª´ng T∆∞·ªõng qu√¢n!</h2>
        <div class="dragon-divider">‚ùñ ‚óà ‚ùñ</div>
        <div class="prize-value" id="prizeDisplay"></div>
        <p style="color: var(--gold-light); font-size: 1rem;">
          Ph·∫ßn th∆∞·ªüng ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!
        </p>
        <div class="back-msg">
          üé≤ H√£y th√¥ng b√°o ph·∫ßn th∆∞·ªüng cho qu·∫£n tr√≤<br/>
          v√† ti·∫øp t·ª•c cu·ªôc phi√™u l∆∞u tr√™n b√†n c·ªù!<br/><br/>
          <em style="font-size: 0.85rem; opacity: 0.7;">Ch√∫c b·∫°n may m·∫Øn trong nh·ªØng l∆∞·ª£t ti·∫øp theo! ‚öî</em>
        </div>
        <button class="btn btn-primary mt-30" onclick="resetGame()">
          üîÑ Ch∆°i l·∫°i
        </button>
      </div>
    </div>

  </div>

  <script src="js/questions.js"></script>
  <script>
    // ==================== GAME STATE ====================
    let currentQuestion = null;
    let timerInterval = null;
    let timeLeft = 30;
    let wheelSpinning = false;
    let currentRotation = 0;

    // ==================== PRIZE CONFIGURATION ====================
    const PRIZES = [
      { name: '100 L∆∞∆°ng th·∫£o', weight: 30, color: '#8B4513', icon: 'üåæ' },
      { name: '200 L∆∞∆°ng th·∫£o', weight: 20, color: '#B22222', icon: 'üåæüåæ' },
      { name: '300 L∆∞∆°ng th·∫£o', weight: 20, color: '#2E7D32', icon: 'üåæüåæüåæ' },
      { name: '400 L∆∞∆°ng th·∫£o', weight: 10, color: '#1A237E', icon: 'üè∫' },
      { name: '500 L∆∞∆°ng th·∫£o', weight: 10, color: '#6A1B9A', icon: 'üí∞' },
      { name: '1 L∆∞·ª£t chi√™u m·ªô\nmi·ªÖn ph√≠', weight: 10, color: '#C62828', icon: '‚öîÔ∏è' }
    ];

    // ==================== QUESTIONS ====================
    function getAllQuestions() {
      const custom = JSON.parse(localStorage.getItem('customQuestions') || '[]');
      return [...QUESTIONS_DB, ...custom];
    }

    function getRandomQuestion() {
      const questions = getAllQuestions();
      return questions[Math.floor(Math.random() * questions.length)];
    }

    // ==================== PHASE MANAGEMENT ====================
    function showPhase(phaseId) {
      document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
      document.getElementById(phaseId).classList.add('active');
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ==================== SHUFFLE ARRAY ====================
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // ==================== START QUIZ ====================
    function startQuiz() {
      const rawQuestion = getRandomQuestion();
      
      // Shuffle options and track correct answer's new position
      const indices = [0, 1, 2, 3];
      const shuffledIndices = shuffleArray(indices);
      const shuffledOptions = shuffledIndices.map(i => rawQuestion.options[i]);
      const newCorrectIndex = shuffledIndices.indexOf(rawQuestion.correct);
      
      currentQuestion = {
        ...rawQuestion,
        options: shuffledOptions,
        correct: newCorrectIndex
      };
      
      // Set category
      document.getElementById('quizCategory').textContent = currentQuestion.category;
      
      // Set question
      document.getElementById('questionText').textContent = currentQuestion.question;
      
      // Set options
      const letters = ['A', 'B', 'C', 'D'];
      const container = document.getElementById('optionsContainer');
      container.innerHTML = currentQuestion.options.map((opt, idx) => `
        <div class="quiz-option" onclick="selectAnswer(this, ${idx})" data-index="${idx}">
          <span class="option-letter">${letters[idx]}</span>
          <span>${opt}</span>
        </div>
      `).join('');

      // Start timer
      timeLeft = 30;
      document.getElementById('timerCount').textContent = timeLeft;
      document.getElementById('timerFill').style.width = '100%';
      
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timerCount').textContent = timeLeft;
        document.getElementById('timerFill').style.width = ((timeLeft / 30) * 100) + '%';
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          handleTimeout();
        }
      }, 1000);

      showPhase('phase-quiz');
    }

    // ==================== SELECT ANSWER ====================
    function selectAnswer(element, selectedIndex) {
      // Prevent multiple selections
      if (document.querySelector('.quiz-option.correct, .quiz-option.wrong')) return;
      
      clearInterval(timerInterval);

      const correctIndex = currentQuestion.correct;
      const options = document.querySelectorAll('.quiz-option');
      
      // Disable all options
      options.forEach(opt => opt.classList.add('disabled'));

      if (selectedIndex === correctIndex) {
        // CORRECT
        element.classList.add('correct');
        setTimeout(() => {
          showPhase('phase-correct');
          launchConfetti();
        }, 1200);
      } else {
        // WRONG
        element.classList.add('wrong');
        options[correctIndex].classList.add('correct');
        
        const letters = ['A', 'B', 'C', 'D'];
        document.getElementById('correctAnswerDisplay').innerHTML = 
          `üìö <strong>ƒê√°p √°n ƒë√∫ng:</strong> ${letters[correctIndex]}. ${currentQuestion.options[correctIndex]}`;
        
        setTimeout(() => {
          showPhase('phase-wrong');
        }, 1500);
      }
    }

    function handleTimeout() {
      const correctIndex = currentQuestion.correct;
      const options = document.querySelectorAll('.quiz-option');
      options.forEach(opt => opt.classList.add('disabled'));
      options[correctIndex].classList.add('correct');
      
      const letters = ['A', 'B', 'C', 'D'];
      document.getElementById('correctAnswerDisplay').innerHTML = 
        `‚è∞ <strong>H·∫øt gi·ªù!</strong> ƒê√°p √°n ƒë√∫ng: ${letters[correctIndex]}. ${currentQuestion.options[correctIndex]}`;
      
      setTimeout(() => {
        showPhase('phase-wrong');
      }, 1500);
    }

    // ==================== SPIN WHEEL ====================
    function showWheel() {
      showPhase('phase-wheel');
      drawWheel();
    }

    function drawWheel() {
      const canvas = document.getElementById('wheelCanvas');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = canvas.width / 2 - 5;

      const totalSegments = PRIZES.length;
      const segmentAngle = (2 * Math.PI) / totalSegments;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      PRIZES.forEach((prize, i) => {
        const startAngle = i * segmentAngle - Math.PI / 2;
        const endAngle = startAngle + segmentAngle;

        // Draw segment
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();

        // Gradient fill
        const gradient = ctx.createRadialGradient(centerX, centerY, 30, centerX, centerY, radius);
        gradient.addColorStop(0, lightenColor(prize.color, 40));
        gradient.addColorStop(1, prize.color);
        ctx.fillStyle = gradient;
        ctx.fill();

        // Border
        ctx.strokeStyle = '#D4A843';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Text
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + segmentAngle / 2);
        ctx.textAlign = 'center';
        ctx.fillStyle = '#FFE8B0';
        ctx.font = 'bold 13px "Be Vietnam Pro", sans-serif';
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 3;

        // Split text lines
        const lines = prize.name.split('\n');
        const textRadius = radius * 0.62;
        lines.forEach((line, li) => {
          ctx.fillText(line, textRadius, (li - (lines.length - 1) / 2) * 16);
        });

        // Icon
        ctx.font = '22px serif';
        ctx.fillText(prize.icon, radius * 0.88, 6);

        ctx.restore();
      });

      // Outer ring decoration
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#D4A843';
      ctx.lineWidth = 3;
      ctx.stroke();

      // Small dots around edge
      for (let i = 0; i < 36; i++) {
        const dotAngle = (i * Math.PI * 2) / 36 - Math.PI / 2;
        const dotX = centerX + (radius - 8) * Math.cos(dotAngle);
        const dotY = centerY + (radius - 8) * Math.sin(dotAngle);
        ctx.beginPath();
        ctx.arc(dotX, dotY, 3, 0, 2 * Math.PI);
        ctx.fillStyle = i % 2 === 0 ? '#FFD700' : '#FFA000';
        ctx.fill();
      }
    }

    function lightenColor(hex, percent) {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = Math.min(255, (num >> 16) + amt);
      const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
      const B = Math.min(255, (num & 0x0000FF) + amt);
      return `rgb(${R},${G},${B})`;
    }

    function spinWheel() {
      if (wheelSpinning) return;
      wheelSpinning = true;
      
      const btn = document.getElementById('spinBtn');
      btn.disabled = true;
      btn.textContent = 'üåÄ ƒêang quay...';

      // Determine prize based on weights
      const prizeIndex = getWeightedPrize();
      
      // Calculate target angle
      const segmentAngle = 360 / PRIZES.length;
      // The pointer is at the top (12 o'clock position)
      // We need the target segment to be at the top when stopped
      const targetAngle = 360 - (prizeIndex * segmentAngle + segmentAngle / 2);
      
      // Add multiple full rotations (5-8) for dramatic effect
      const fullRotations = 5 + Math.floor(Math.random() * 3);
      const totalRotation = fullRotations * 360 + targetAngle;
      
      currentRotation += totalRotation;
      
      const canvas = document.getElementById('wheelCanvas');
      canvas.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
      canvas.style.transform = `rotate(${currentRotation}deg)`;

      // Sound effect simulation via animation
      const pointer = document.querySelector('.wheel-pointer');
      pointer.style.animation = 'none';

      setTimeout(() => {
        wheelSpinning = false;
        pointer.style.animation = 'pointerBounce 1s ease-in-out infinite';
        showPrizeResult(prizeIndex);
      }, 5500);
    }

    function getWeightedPrize() {
      const totalWeight = PRIZES.reduce((sum, p) => sum + p.weight, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < PRIZES.length; i++) {
        random -= PRIZES[i].weight;
        if (random <= 0) return i;
      }
      return PRIZES.length - 1;
    }

    function showPrizeResult(prizeIndex) {
      const prize = PRIZES[prizeIndex];
      document.getElementById('prizeDisplay').textContent = prize.name.replace('\n', ' ');
      
      showPhase('phase-prize');
      launchConfetti();
      launchConfetti();
    }

    // ==================== CONFETTI ====================
    function launchConfetti() {
      const container = document.getElementById('confettiContainer');
      const colors = ['#FFD700', '#D4A843', '#FF4444', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0'];
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.width = (Math.random() * 8 + 5) + 'px';
          confetti.style.height = (Math.random() * 8 + 5) + 'px';
          confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          confetti.style.animationDelay = (Math.random() * 0.5) + 's';
          container.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 4000);
        }, i * 30);
      }
    }

    // ==================== RESET ====================
    function resetGame() {
      currentQuestion = null;
      if (timerInterval) clearInterval(timerInterval);
      
      // Reset wheel
      const canvas = document.getElementById('wheelCanvas');
      canvas.style.transition = 'none';
      currentRotation = 0;
      canvas.style.transform = 'rotate(0deg)';
      
      const btn = document.getElementById('spinBtn');
      btn.disabled = false;
      btn.textContent = 'üé∞ QUAY NGAY';
      
      wheelSpinning = false;
      
      showPhase('phase-welcome');
    }

    // ==================== LOADING SCREEN ====================
    function startLoading() {
      const bar = document.getElementById('loadingBar');
      const percentText = document.getElementById('loadingPercent');
      let progress = 0;
      
      const tips = [
        'ƒêang t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠',
        'ƒêang chu·∫©n b·ªã c√¢u h·ªèi',
        'ƒêang kh·ªüi t·∫°o v√≤ng quay',
        'S·∫Øp ho√†n t·∫•t'
      ];
      const tipEl = document.querySelector('.loading-dots');
      
      const interval = setInterval(() => {
        progress += Math.random() * 8 + 2;
        if (progress >= 100) progress = 100;
        
        bar.style.width = progress + '%';
        percentText.textContent = Math.floor(progress) + '%';
        
        // Update tip text
        if (progress < 30) tipEl.textContent = tips[0];
        else if (progress < 60) tipEl.textContent = tips[1];
        else if (progress < 85) tipEl.textContent = tips[2];
        else tipEl.textContent = tips[3];
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            showPhase('phase-welcome');
          }, 500);
        }
      }, 120);
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
      // Draw wheel initially so it's ready
      setTimeout(drawWheel, 100);
      // Start loading animation
      startLoading();
    });
  </script>
</body>
</html>
