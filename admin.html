<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âš” Quáº£n trá»‹ - Lá»‹ch Sá»­ Phong Kiáº¿n Viá»‡t Nam</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="bg-pattern"></div>

  <!-- HEADER -->
  <header class="header">
    <h1>ğŸ¯ QUáº¢N TRá»Š VIÃŠN</h1>
    <div class="subtitle">Há»‡ thá»‘ng cÃ¢u há»i Lá»‹ch sá»­ Phong kiáº¿n Viá»‡t Nam</div>
  </header>

  <div class="dragon-divider">â– â—ˆ â–</div>

  <div class="container">
    <!-- TABS -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('tab-qr')">ğŸ“± Táº¡o mÃ£ QR</button>
      <button class="admin-tab" onclick="switchTab('tab-questions')">ğŸ“‹ Danh sÃ¡ch cÃ¢u há»i</button>
      <button class="admin-tab" onclick="switchTab('tab-add')">â• ThÃªm cÃ¢u há»i</button>
    </div>

    <!-- ==================== TAB: Táº O MÃƒ QR ==================== -->
    <div id="tab-qr" class="tab-content active">
      <div class="card">
        <h2>ğŸ“± Táº¡o mÃ£ QR cho Boardgame</h2>
        <p style="color: var(--gold-light); margin-bottom: 15px;">
          MÃ£ QR nÃ y sáº½ dáº«n ngÆ°á»i chÆ¡i Ä‘áº¿n trang tráº£ lá»i cÃ¢u há»i tráº¯c nghiá»‡m. 
          Khi quÃ©t, há»‡ thá»‘ng sáº½ chá»n ngáº«u nhiÃªn 1 cÃ¢u há»i cho ngÆ°á»i chÆ¡i.
        </p>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">URL trang quiz (tá»± Ä‘á»™ng):</label>
          <input type="text" id="quizUrl" placeholder="Nháº­p URL hoáº·c Ä‘á»ƒ máº·c Ä‘á»‹nh..." />
          <p style="font-size: 0.8rem; color: var(--gold-dark);">
            ğŸ’¡ Náº¿u deploy lÃªn hosting, hÃ£y nháº­p URL Ä‘áº§y Ä‘á»§. VÃ­ dá»¥: https://yourdomain.com/play.html
          </p>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="generateQR()">ğŸ”² Táº¡o mÃ£ QR</button>
          <button class="btn btn-secondary" onclick="downloadQR()">ğŸ“¥ Táº£i QR vá»</button>
          <button class="btn btn-secondary" onclick="generateMultipleQR()">ğŸ”²Ã—6 Táº¡o nhiá»u QR (in bÃ n cá»)</button>
        </div>
      </div>

      <div class="card qr-container" id="qrResult" style="display:none;">
        <h3>âœ¨ MÃ£ QR cá»§a báº¡n</h3>
        <div class="qr-box" id="qrCode"></div>
        <div class="qr-label">QuÃ©t mÃ£ nÃ y Ä‘á»ƒ báº¯t Ä‘áº§u tráº£ lá»i cÃ¢u há»i lá»‹ch sá»­</div>
      </div>

      <!-- Multiple QR for printing -->
      <div class="card" id="multiQrResult" style="display:none;">
        <h3>ğŸ² Bá»™ mÃ£ QR cho bÃ n cá» (In ra vÃ  cáº¯t dÃ¡n)</h3>
        <p style="color: var(--gold-light); font-size: 0.85rem; margin-bottom: 15px;">
          Táº¥t cáº£ cÃ¡c mÃ£ QR Ä‘á»u trá» Ä‘áº¿n cÃ¹ng 1 trang quiz, má»—i láº§n quÃ©t sáº½ ra cÃ¢u há»i ngáº«u nhiÃªn khÃ¡c nhau.
        </p>
        <div id="multiQrGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;"></div>
        <div class="btn-group" style="justify-content: center; margin-top: 20px;">
          <button class="btn btn-primary" onclick="printQRs()">ğŸ–¨ï¸ In trang QR</button>
        </div>
      </div>
    </div>

    <!-- ==================== TAB: DANH SÃCH CÃ‚U Há»I ==================== -->
    <div id="tab-questions" class="tab-content">
      <!-- Stats -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-number" id="totalQuestions">0</div>
          <div class="stat-label">Tá»•ng cÃ¢u há»i</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalCategories">0</div>
          <div class="stat-label">Chá»§ Ä‘á»</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="customQuestions">0</div>
          <div class="stat-label">CÃ¢u tá»± thÃªm</div>
        </div>
      </div>

      <!-- Filter -->
      <div class="card">
        <div class="filter-bar">
          <select id="filterCategory" onchange="filterQuestions()">
            <option value="all">ğŸ“š Táº¥t cáº£ chá»§ Ä‘á»</option>
          </select>
          <input type="text" id="filterSearch" placeholder="ğŸ” TÃ¬m kiáº¿m cÃ¢u há»i..." oninput="filterQuestions()" style="flex: 1;" />
        </div>

        <div class="scroll-hint">â¬‡ Cuá»™n Ä‘á»ƒ xem thÃªm</div>
        <div class="question-list" id="questionList">
          <!-- Dynamic content -->
        </div>
      </div>
    </div>

    <!-- ==================== TAB: THÃŠM CÃ‚U Há»I ==================== -->
    <div id="tab-add" class="tab-content">
      <div class="card">
        <h2>â• ThÃªm cÃ¢u há»i má»›i</h2>
        
        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">CÃ¢u há»i:</label>
          <textarea id="newQuestion" placeholder="Nháº­p cÃ¢u há»i tráº¯c nghiá»‡m..."></textarea>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">Chá»§ Ä‘á»:</label>
          <input type="text" id="newCategory" placeholder="VÃ­ dá»¥: NhÃ  Tráº§n, NhÃ  LÃ½..." />
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">ÄÃ¡p Ã¡n A:</label>
          <input type="text" id="optionA" placeholder="ÄÃ¡p Ã¡n A (Ä‘Ã¡p Ã¡n Ä‘Ãºng)" />
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">ÄÃ¡p Ã¡n B:</label>
          <input type="text" id="optionB" placeholder="ÄÃ¡p Ã¡n B" />
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">ÄÃ¡p Ã¡n C:</label>
          <input type="text" id="optionC" placeholder="ÄÃ¡p Ã¡n C" />
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">ÄÃ¡p Ã¡n D:</label>
          <input type="text" id="optionD" placeholder="ÄÃ¡p Ã¡n D" />
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: var(--gold-light); font-size: 0.9rem;">ÄÃ¡p Ã¡n Ä‘Ãºng:</label>
          <select id="correctAnswer">
            <option value="0">A</option>
            <option value="1">B</option>
            <option value="2">C</option>
            <option value="3">D</option>
          </select>
        </div>

        <div class="btn-group">
          <button class="btn btn-success" onclick="addQuestion()">âœ… ThÃªm cÃ¢u há»i</button>
          <button class="btn btn-secondary" onclick="clearForm()">ğŸ—‘ï¸ XoÃ¡ form</button>
        </div>
      </div>

      <!-- Bulk import -->
      <div class="card">
        <h2>ğŸ“¦ Nháº­p hÃ ng loáº¡t (JSON)</h2>
        <p style="color: var(--gold-light); font-size: 0.85rem; margin-bottom: 10px;">
          DÃ¡n danh sÃ¡ch cÃ¢u há»i theo Ä‘á»‹nh dáº¡ng JSON Ä‘á»ƒ thÃªm nhiá»u cÃ¢u cÃ¹ng lÃºc.
        </p>
        <textarea id="bulkJson" placeholder='[{"question":"...","options":["A","B","C","D"],"correct":0,"category":"NhÃ  Tráº§n"}]' style="min-height: 150px; font-family: monospace; font-size: 0.85rem;"></textarea>
        <div class="btn-group">
          <button class="btn btn-success" onclick="bulkImport()">ğŸ“¥ Nháº­p hÃ ng loáº¡t</button>
        </div>
      </div>

      <!-- Export -->
      <div class="card">
        <h2>ğŸ“¤ Xuáº¥t dá»¯ liá»‡u</h2>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="exportQuestions()">ğŸ“¤ Xuáº¥t JSON</button>
          <button class="btn btn-danger" onclick="resetToDefault()">ğŸ”„ KhÃ´i phá»¥c máº·c Ä‘á»‹nh (100 cÃ¢u)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <script src="js/questions.js"></script>
  <script>
    // ==================== DATA MANAGEMENT ====================
    function getAllQuestions() {
      const custom = JSON.parse(localStorage.getItem('customQuestions') || '[]');
      return [...QUESTIONS_DB, ...custom];
    }

    function getCustomQuestions() {
      return JSON.parse(localStorage.getItem('customQuestions') || '[]');
    }

    function saveCustomQuestions(questions) {
      localStorage.setItem('customQuestions', JSON.stringify(questions));
    }

    // ==================== TABS ====================
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      
      if (tabId === 'tab-questions') {
        renderQuestionList();
        updateStats();
      }
    }

    // ==================== QR CODE ====================
    let qrInstance = null;

    function getQuizURL() {
      const customUrl = document.getElementById('quizUrl').value.trim();
      if (customUrl) return customUrl;
      
      // Auto-detect URL
      const currentUrl = window.location.href;
      const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
      return baseUrl + 'play.html';
    }

    function generateQR() {
      const url = getQuizURL();
      const container = document.getElementById('qrCode');
      const result = document.getElementById('qrResult');
      
      container.innerHTML = '';
      result.style.display = 'block';

      qrInstance = new QRCode(container, {
        text: url,
        width: 250,
        height: 250,
        colorDark: '#1a0f0a',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });

      showToast('âœ… ÄÃ£ táº¡o mÃ£ QR thÃ nh cÃ´ng!');
    }

    function downloadQR() {
      const canvas = document.querySelector('#qrCode canvas');
      if (!canvas) {
        showToast('âš ï¸ HÃ£y táº¡o mÃ£ QR trÆ°á»›c!');
        return;
      }
      const link = document.createElement('a');
      link.download = 'boardgame-lichsu-qr.png';
      link.href = canvas.toDataURL();
      link.click();
      showToast('ğŸ“¥ ÄÃ£ táº£i QR vá»!');
    }

    function generateMultipleQR() {
      const url = getQuizURL();
      const grid = document.getElementById('multiQrGrid');
      const result = document.getElementById('multiQrResult');
      
      grid.innerHTML = '';
      result.style.display = 'block';

      for (let i = 0; i < 6; i++) {
        const cell = document.createElement('div');
        cell.style.cssText = 'text-align:center; background: white; padding: 15px; border-radius: 8px;';
        
        const qrDiv = document.createElement('div');
        qrDiv.id = 'multiQr' + i;
        cell.appendChild(qrDiv);
        
        const label = document.createElement('p');
        label.style.cssText = 'margin-top:8px; font-size:0.75rem; color:#333; font-weight:600;';
        label.textContent = `Ã” QR #${i + 1}`;
        cell.appendChild(label);
        
        grid.appendChild(cell);

        new QRCode(qrDiv, {
          text: url,
          width: 150,
          height: 150,
          colorDark: '#1a0f0a',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      }

      showToast('âœ… ÄÃ£ táº¡o 6 mÃ£ QR Ä‘á»ƒ in!');
    }

    function printQRs() {
      window.print();
    }

    // ==================== QUESTION LIST ====================
    function renderQuestionList() {
      const list = document.getElementById('questionList');
      const allQ = getAllQuestions();
      const filter = document.getElementById('filterCategory').value;
      const search = document.getElementById('filterSearch').value.toLowerCase();

      let filtered = allQ;
      if (filter !== 'all') {
        filtered = filtered.filter(q => q.category === filter);
      }
      if (search) {
        filtered = filtered.filter(q => 
          q.question.toLowerCase().includes(search) || 
          q.category.toLowerCase().includes(search)
        );
      }

      const letters = ['A', 'B', 'C', 'D'];
      list.innerHTML = filtered.map((q, idx) => `
        <div class="question-item">
          <span class="q-number">${q.id || idx + 1}</span>
          <span class="q-category">${q.category}</span>
          <div class="q-text">${q.question}</div>
          <ul class="q-options">
            ${q.options.map((opt, oi) => `
              <li class="${oi === q.correct ? 'correct' : ''}">${letters[oi]}. ${opt}</li>
            `).join('')}
          </ul>
        </div>
      `).join('');

      // Update category filter
      const categories = [...new Set(allQ.map(q => q.category))];
      const catSelect = document.getElementById('filterCategory');
      const currentVal = catSelect.value;
      catSelect.innerHTML = '<option value="all">ğŸ“š Táº¥t cáº£ chá»§ Ä‘á»</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        if (cat === currentVal) opt.selected = true;
        catSelect.appendChild(opt);
      });
    }

    function filterQuestions() {
      renderQuestionList();
    }

    function updateStats() {
      const allQ = getAllQuestions();
      const custom = getCustomQuestions();
      const categories = [...new Set(allQ.map(q => q.category))];
      
      document.getElementById('totalQuestions').textContent = allQ.length;
      document.getElementById('totalCategories').textContent = categories.length;
      document.getElementById('customQuestions').textContent = custom.length;
    }

    // ==================== ADD QUESTION ====================
    function addQuestion() {
      const question = document.getElementById('newQuestion').value.trim();
      const category = document.getElementById('newCategory').value.trim();
      const optA = document.getElementById('optionA').value.trim();
      const optB = document.getElementById('optionB').value.trim();
      const optC = document.getElementById('optionC').value.trim();
      const optD = document.getElementById('optionD').value.trim();
      const correct = parseInt(document.getElementById('correctAnswer').value);

      if (!question || !category || !optA || !optB || !optC || !optD) {
        showToast('âš ï¸ Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
        return;
      }

      const custom = getCustomQuestions();
      const allQ = getAllQuestions();
      const newId = allQ.length + 1;

      custom.push({
        id: newId,
        question,
        options: [optA, optB, optC, optD],
        correct,
        category,
        custom: true
      });

      saveCustomQuestions(custom);
      clearForm();
      showToast('âœ… ÄÃ£ thÃªm cÃ¢u há»i thÃ nh cÃ´ng!');
    }

    function clearForm() {
      document.getElementById('newQuestion').value = '';
      document.getElementById('newCategory').value = '';
      document.getElementById('optionA').value = '';
      document.getElementById('optionB').value = '';
      document.getElementById('optionC').value = '';
      document.getElementById('optionD').value = '';
      document.getElementById('correctAnswer').value = '0';
    }

    // ==================== BULK IMPORT ====================
    function bulkImport() {
      const json = document.getElementById('bulkJson').value.trim();
      if (!json) {
        showToast('âš ï¸ Vui lÃ²ng dÃ¡n dá»¯ liá»‡u JSON!');
        return;
      }

      try {
        const data = JSON.parse(json);
        if (!Array.isArray(data)) throw new Error('Pháº£i lÃ  máº£ng');

        const custom = getCustomQuestions();
        let count = 0;
        const allQ = getAllQuestions();

        data.forEach((item, idx) => {
          if (item.question && item.options && item.options.length === 4 && typeof item.correct === 'number') {
            custom.push({
              id: allQ.length + count + 1,
              question: item.question,
              options: item.options,
              correct: item.correct,
              category: item.category || 'ChÆ°a phÃ¢n loáº¡i',
              custom: true
            });
            count++;
          }
        });

        saveCustomQuestions(custom);
        document.getElementById('bulkJson').value = '';
        showToast(`âœ… ÄÃ£ nháº­p ${count} cÃ¢u há»i thÃ nh cÃ´ng!`);
      } catch (e) {
        showToast('âŒ Lá»—i JSON: ' + e.message);
      }
    }

    // ==================== EXPORT ====================
    function exportQuestions() {
      const allQ = getAllQuestions();
      const json = JSON.stringify(allQ, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      link.download = 'questions-lichsu-phongkien.json';
      link.href = URL.createObjectURL(blob);
      link.click();
      showToast('ğŸ“¤ ÄÃ£ xuáº¥t dá»¯ liá»‡u!');
    }

    function resetToDefault() {
      if (confirm('âš ï¸ Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ táº¥t cáº£ cÃ¢u há»i tá»± thÃªm vÃ  khÃ´i phá»¥c vá» 100 cÃ¢u máº·c Ä‘á»‹nh?')) {
        localStorage.removeItem('customQuestions');
        showToast('ğŸ”„ ÄÃ£ khÃ´i phá»¥c vá» máº·c Ä‘á»‹nh!');
        renderQuestionList();
        updateStats();
      }
    }

    // ==================== TOAST ====================
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
      // Set default URL
      const currentUrl = window.location.href;
      const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
      document.getElementById('quizUrl').placeholder = baseUrl + 'play.html';
      
      updateStats();
    });
  </script>

  <!-- Print styles -->
  <style>
    @media print {
      body { background: white !important; }
      .bg-pattern, .header, .admin-tabs, #tab-qr > .card:first-child, 
      #tab-questions, #tab-add, .toast, .dragon-divider,
      #qrResult, .btn-group { display: none !important; }
      #multiQrResult { 
        display: block !important;
        border: none !important;
        box-shadow: none !important;
        background: white !important;
      }
      #multiQrGrid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 15px !important;
      }
      #multiQrGrid > div {
        border: 2px dashed #ccc !important;
        break-inside: avoid;
      }
    }
  </style>
</body>
</html>
